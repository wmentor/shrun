# ShRun

##  Установка

Для сборки и использования shrun нужно иметь установленный docker, git, make и go (1.18). 

В переменную PATH нужно добавить путь к директории $GOPATH/bin.

Клонируем репозиторий и собираем shrun.

```bash
git clone git@github.com:wmentor/shrun.git
cd shrun
make
```

## Инициализация

```
shrun init
```

В конфигурационной директории создает Dockerfile-ы, sdmspec.json, rc.local. В качестве директории по умолчанию используется *~/.shrun* (если ее нет, 
то она будет создана при первом запуске). Для того чтобы поменять директорию по умолчанию нужно задать переменную окружения *SHRDM_CONFIG_DIR*.

Для получения информации о всех параметрах команды вызовите ее с ключем *-h*.

## Получения необходимых образов докера

```
shrun pull
```

В результате будут синхронизованы имеджи для go, ubuntu, postgres.

## Сборка образа Shardman

```
shrun build --build-basic --build-pg
```

Для докеров используется каталог ~/build (может быть ссылкой). Если нужно его сменить, то стоит задать переменную окружения *SHRDM_DATA_DIR*.

Если не задать ключи --build-basic и --build-pg, то будет только пересобран образ с новой обвязкой на базе последней сборки постгреса.

*--build-basic* нужен для пересборки всех базовых образов, которые используются для сборки постгреса, но сам постгрес при этом не собирается.

*--build-pg* указывает на то, что нужно пересобрать постгрес.

Обвязка пересобирается при любой конфигурации ключей.

## Запуск кластера

```
shrun start --nodes count
```

Запускает кластер из заданного числа нод (по умолчанию выполняется shardmanctl init + shardmanctl nodes add). 

Если ноды не нужно добавлять в кластер,  то нужно добавить флаг --skip-node-add.

Собрать следующий кластер можно будет теперь только после остановки (даже если сборка прошла неуспешно).

В случае успешного запуска в build-каталоге будет создана директория /mntdata, которая будет подмонтирована ко всем запущенным контейнерам.

## Остановка кластера

```
shrun stop
```

## Генерация документации по Shardman

```
shrun doc
```

Команда сгенерирует документацию по шардману и напечатает каталог, в который она была сохранена.
